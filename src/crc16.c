/*
 * CYCLIC REDUNDANCY CHECK
 * written by \u5C0F\u6797\u79C0\u884C
 *
 * References:
 * - https://en.wikipedia.org/wiki/Cyclic_redundancy_check
 * - https://www.nist.gov/dads/HTML/cyclicRedundancyCheck.html
 * - https://www.mathpages.com/home/kmath458.htm
 * - http://www.ross.net/crc/download/crc_v3.txt
 * - isbn-13:978-0-321-84268-8
 */

#include "crc16.h"

#if (CRC16_GP & 0x7Fu) == 0x01u
#define X0(n) (0x00u ^ ((n) >> 0))
#define X1(n) (X0(n) ^ ((n) >> 1))
#define X2(n) (X1(n) ^ ((n) >> 2))
#define X3(n) (X2(n) ^ ((n) >> 3))
#define X4(n) (X3(n) ^ ((n) >> 4))
#define X5(n) (X4(n) ^ ((n) >> 5))
#define X6(n) (X5(n) ^ ((n) >> 6))
#define X7(n) (X6(n) ^ ((n) >> 7))
#define CRC(n) \
	((-(X0(n) & 1u) & (CRC16_GP >> 7)) ^ \
	 (-(X1(n) & 1u) & (CRC16_GP >> 6)) ^ \
	 (-(X2(n) & 1u) & (CRC16_GP >> 5)) ^ \
	 (-(X3(n) & 1u) & (CRC16_GP >> 4)) ^ \
	 (-(X4(n) & 1u) & (CRC16_GP >> 3)) ^ \
	 (-(X5(n) & 1u) & (CRC16_GP >> 2)) ^ \
	 (-(X6(n) & 1u) & (CRC16_GP >> 1)) ^ \
	 (-(X7(n) & 1u) & (CRC16_GP >> 0)))
#else
#define XOR(a) (((a) >> 1) ^ (-((a) & 1u) & CRC16_GP))
#define CRC(n) XOR(XOR(XOR(XOR(XOR(XOR(XOR(XOR(n))))))))
#endif

static const unsigned int table[0x100] = {
	CRC(0x00u), CRC(0x01u), CRC(0x02u), CRC(0x03u), CRC(0x04u), CRC(0x05u), CRC(0x06u), CRC(0x07u), CRC(0x08u), CRC(0x09u), CRC(0x0Au), CRC(0x0Bu), CRC(0x0Cu), CRC(0x0Du), CRC(0x0Eu), CRC(0x0Fu),
	CRC(0x10u), CRC(0x11u), CRC(0x12u), CRC(0x13u), CRC(0x14u), CRC(0x15u), CRC(0x16u), CRC(0x17u), CRC(0x18u), CRC(0x19u), CRC(0x1Au), CRC(0x1Bu), CRC(0x1Cu), CRC(0x1Du), CRC(0x1Eu), CRC(0x1Fu),
	CRC(0x20u), CRC(0x21u), CRC(0x22u), CRC(0x23u), CRC(0x24u), CRC(0x25u), CRC(0x26u), CRC(0x27u), CRC(0x28u), CRC(0x29u), CRC(0x2Au), CRC(0x2Bu), CRC(0x2Cu), CRC(0x2Du), CRC(0x2Eu), CRC(0x2Fu),
	CRC(0x30u), CRC(0x31u), CRC(0x32u), CRC(0x33u), CRC(0x34u), CRC(0x35u), CRC(0x36u), CRC(0x37u), CRC(0x38u), CRC(0x39u), CRC(0x3Au), CRC(0x3Bu), CRC(0x3Cu), CRC(0x3Du), CRC(0x3Eu), CRC(0x3Fu),
	CRC(0x40u), CRC(0x41u), CRC(0x42u), CRC(0x43u), CRC(0x44u), CRC(0x45u), CRC(0x46u), CRC(0x47u), CRC(0x48u), CRC(0x49u), CRC(0x4Au), CRC(0x4Bu), CRC(0x4Cu), CRC(0x4Du), CRC(0x4Eu), CRC(0x4Fu),
	CRC(0x50u), CRC(0x51u), CRC(0x52u), CRC(0x53u), CRC(0x54u), CRC(0x55u), CRC(0x56u), CRC(0x57u), CRC(0x58u), CRC(0x59u), CRC(0x5Au), CRC(0x5Bu), CRC(0x5Cu), CRC(0x5Du), CRC(0x5Eu), CRC(0x5Fu),
	CRC(0x60u), CRC(0x61u), CRC(0x62u), CRC(0x63u), CRC(0x64u), CRC(0x65u), CRC(0x66u), CRC(0x67u), CRC(0x68u), CRC(0x69u), CRC(0x6Au), CRC(0x6Bu), CRC(0x6Cu), CRC(0x6Du), CRC(0x6Eu), CRC(0x6Fu),
	CRC(0x70u), CRC(0x71u), CRC(0x72u), CRC(0x73u), CRC(0x74u), CRC(0x75u), CRC(0x76u), CRC(0x77u), CRC(0x78u), CRC(0x79u), CRC(0x7Au), CRC(0x7Bu), CRC(0x7Cu), CRC(0x7Du), CRC(0x7Eu), CRC(0x7Fu),
	CRC(0x80u), CRC(0x81u), CRC(0x82u), CRC(0x83u), CRC(0x84u), CRC(0x85u), CRC(0x86u), CRC(0x87u), CRC(0x88u), CRC(0x89u), CRC(0x8Au), CRC(0x8Bu), CRC(0x8Cu), CRC(0x8Du), CRC(0x8Eu), CRC(0x8Fu),
	CRC(0x90u), CRC(0x91u), CRC(0x92u), CRC(0x93u), CRC(0x94u), CRC(0x95u), CRC(0x96u), CRC(0x97u), CRC(0x98u), CRC(0x99u), CRC(0x9Au), CRC(0x9Bu), CRC(0x9Cu), CRC(0x9Du), CRC(0x9Eu), CRC(0x9Fu),
	CRC(0xA0u), CRC(0xA1u), CRC(0xA2u), CRC(0xA3u), CRC(0xA4u), CRC(0xA5u), CRC(0xA6u), CRC(0xA7u), CRC(0xA8u), CRC(0xA9u), CRC(0xAAu), CRC(0xABu), CRC(0xACu), CRC(0xADu), CRC(0xAEu), CRC(0xAFu),
	CRC(0xB0u), CRC(0xB1u), CRC(0xB2u), CRC(0xB3u), CRC(0xB4u), CRC(0xB5u), CRC(0xB6u), CRC(0xB7u), CRC(0xB8u), CRC(0xB9u), CRC(0xBAu), CRC(0xBBu), CRC(0xBCu), CRC(0xBDu), CRC(0xBEu), CRC(0xBFu),
	CRC(0xC0u), CRC(0xC1u), CRC(0xC2u), CRC(0xC3u), CRC(0xC4u), CRC(0xC5u), CRC(0xC6u), CRC(0xC7u), CRC(0xC8u), CRC(0xC9u), CRC(0xCAu), CRC(0xCBu), CRC(0xCCu), CRC(0xCDu), CRC(0xCEu), CRC(0xCFu),
	CRC(0xD0u), CRC(0xD1u), CRC(0xD2u), CRC(0xD3u), CRC(0xD4u), CRC(0xD5u), CRC(0xD6u), CRC(0xD7u), CRC(0xD8u), CRC(0xD9u), CRC(0xDAu), CRC(0xDBu), CRC(0xDCu), CRC(0xDDu), CRC(0xDEu), CRC(0xDFu),
	CRC(0xE0u), CRC(0xE1u), CRC(0xE2u), CRC(0xE3u), CRC(0xE4u), CRC(0xE5u), CRC(0xE6u), CRC(0xE7u), CRC(0xE8u), CRC(0xE9u), CRC(0xEAu), CRC(0xEBu), CRC(0xECu), CRC(0xEDu), CRC(0xEEu), CRC(0xEFu),
	CRC(0xF0u), CRC(0xF1u), CRC(0xF2u), CRC(0xF3u), CRC(0xF4u), CRC(0xF5u), CRC(0xF6u), CRC(0xF7u), CRC(0xF8u), CRC(0xF9u), CRC(0xFAu), CRC(0xFBu), CRC(0xFCu), CRC(0xFDu), CRC(0xFEu), CRC(0xFFu),
};

unsigned int crc16(unsigned int crc, const void *message, size_t length)
{
	const unsigned char *p = message;

	while (length--) {
		crc = (crc >> 010) ^ table[(crc ^ *p++) & 0xFFu];
	}

	return crc;
}
