/*
 * CYCLIC REDUNDANCY CHECK
 * written by \u5C0F\u6797\u79C0\u884C
 *
 * References:
 * - https://en.wikipedia.org/wiki/Cyclic_redundancy_check
 * - https://www.nist.gov/dads/HTML/cyclicRedundancyCheck.html
 * - https://www.mathpages.com/home/kmath458.htm
 * - http://www.ross.net/crc/download/crc_v3.txt
 * - isbn-13:978-0-321-84268-8
 */

#include "crc32.h"

#if (CRC32_GP & 0x7FuL) == 0x01uL
#define XOR0(n) ((0x0uL) ^ ((n) >> 0))
#define XOR1(n) (XOR0(n) ^ ((n) >> 1))
#define XOR2(n) (XOR1(n) ^ ((n) >> 2))
#define XOR3(n) (XOR2(n) ^ ((n) >> 3))
#define XOR4(n) (XOR3(n) ^ ((n) >> 4))
#define XOR5(n) (XOR4(n) ^ ((n) >> 5))
#define XOR6(n) (XOR5(n) ^ ((n) >> 6))
#define XOR7(n) (XOR6(n) ^ ((n) >> 7))
#define CRC(n) \
	((-(XOR0(n) & 1uL) & (CRC32_GP >> 7)) ^ \
	 (-(XOR1(n) & 1uL) & (CRC32_GP >> 6)) ^ \
	 (-(XOR2(n) & 1uL) & (CRC32_GP >> 5)) ^ \
	 (-(XOR3(n) & 1uL) & (CRC32_GP >> 4)) ^ \
	 (-(XOR4(n) & 1uL) & (CRC32_GP >> 3)) ^ \
	 (-(XOR5(n) & 1uL) & (CRC32_GP >> 2)) ^ \
	 (-(XOR6(n) & 1uL) & (CRC32_GP >> 1)) ^ \
	 (-(XOR7(n) & 1uL) & (CRC32_GP >> 0)))
#else
#define XOR(a) (((a) >> 1) ^ (-((a) & 1uL) & CRC32_GP))
#define CRC(n) XOR(XOR(XOR(XOR(XOR(XOR(XOR(XOR(n))))))))
#endif

static const unsigned long int table[0x100] = {
	CRC(0x00uL), CRC(0x01uL), CRC(0x02uL), CRC(0x03uL), CRC(0x04uL), CRC(0x05uL), CRC(0x06uL), CRC(0x07uL), CRC(0x08uL), CRC(0x09uL), CRC(0x0AuL), CRC(0x0BuL), CRC(0x0CuL), CRC(0x0DuL), CRC(0x0EuL), CRC(0x0FuL),
	CRC(0x10uL), CRC(0x11uL), CRC(0x12uL), CRC(0x13uL), CRC(0x14uL), CRC(0x15uL), CRC(0x16uL), CRC(0x17uL), CRC(0x18uL), CRC(0x19uL), CRC(0x1AuL), CRC(0x1BuL), CRC(0x1CuL), CRC(0x1DuL), CRC(0x1EuL), CRC(0x1FuL),
	CRC(0x20uL), CRC(0x21uL), CRC(0x22uL), CRC(0x23uL), CRC(0x24uL), CRC(0x25uL), CRC(0x26uL), CRC(0x27uL), CRC(0x28uL), CRC(0x29uL), CRC(0x2AuL), CRC(0x2BuL), CRC(0x2CuL), CRC(0x2DuL), CRC(0x2EuL), CRC(0x2FuL),
	CRC(0x30uL), CRC(0x31uL), CRC(0x32uL), CRC(0x33uL), CRC(0x34uL), CRC(0x35uL), CRC(0x36uL), CRC(0x37uL), CRC(0x38uL), CRC(0x39uL), CRC(0x3AuL), CRC(0x3BuL), CRC(0x3CuL), CRC(0x3DuL), CRC(0x3EuL), CRC(0x3FuL),
	CRC(0x40uL), CRC(0x41uL), CRC(0x42uL), CRC(0x43uL), CRC(0x44uL), CRC(0x45uL), CRC(0x46uL), CRC(0x47uL), CRC(0x48uL), CRC(0x49uL), CRC(0x4AuL), CRC(0x4BuL), CRC(0x4CuL), CRC(0x4DuL), CRC(0x4EuL), CRC(0x4FuL),
	CRC(0x50uL), CRC(0x51uL), CRC(0x52uL), CRC(0x53uL), CRC(0x54uL), CRC(0x55uL), CRC(0x56uL), CRC(0x57uL), CRC(0x58uL), CRC(0x59uL), CRC(0x5AuL), CRC(0x5BuL), CRC(0x5CuL), CRC(0x5DuL), CRC(0x5EuL), CRC(0x5FuL),
	CRC(0x60uL), CRC(0x61uL), CRC(0x62uL), CRC(0x63uL), CRC(0x64uL), CRC(0x65uL), CRC(0x66uL), CRC(0x67uL), CRC(0x68uL), CRC(0x69uL), CRC(0x6AuL), CRC(0x6BuL), CRC(0x6CuL), CRC(0x6DuL), CRC(0x6EuL), CRC(0x6FuL),
	CRC(0x70uL), CRC(0x71uL), CRC(0x72uL), CRC(0x73uL), CRC(0x74uL), CRC(0x75uL), CRC(0x76uL), CRC(0x77uL), CRC(0x78uL), CRC(0x79uL), CRC(0x7AuL), CRC(0x7BuL), CRC(0x7CuL), CRC(0x7DuL), CRC(0x7EuL), CRC(0x7FuL),
	CRC(0x80uL), CRC(0x81uL), CRC(0x82uL), CRC(0x83uL), CRC(0x84uL), CRC(0x85uL), CRC(0x86uL), CRC(0x87uL), CRC(0x88uL), CRC(0x89uL), CRC(0x8AuL), CRC(0x8BuL), CRC(0x8CuL), CRC(0x8DuL), CRC(0x8EuL), CRC(0x8FuL),
	CRC(0x90uL), CRC(0x91uL), CRC(0x92uL), CRC(0x93uL), CRC(0x94uL), CRC(0x95uL), CRC(0x96uL), CRC(0x97uL), CRC(0x98uL), CRC(0x99uL), CRC(0x9AuL), CRC(0x9BuL), CRC(0x9CuL), CRC(0x9DuL), CRC(0x9EuL), CRC(0x9FuL),
	CRC(0xA0uL), CRC(0xA1uL), CRC(0xA2uL), CRC(0xA3uL), CRC(0xA4uL), CRC(0xA5uL), CRC(0xA6uL), CRC(0xA7uL), CRC(0xA8uL), CRC(0xA9uL), CRC(0xAAuL), CRC(0xABuL), CRC(0xACuL), CRC(0xADuL), CRC(0xAEuL), CRC(0xAFuL),
	CRC(0xB0uL), CRC(0xB1uL), CRC(0xB2uL), CRC(0xB3uL), CRC(0xB4uL), CRC(0xB5uL), CRC(0xB6uL), CRC(0xB7uL), CRC(0xB8uL), CRC(0xB9uL), CRC(0xBAuL), CRC(0xBBuL), CRC(0xBCuL), CRC(0xBDuL), CRC(0xBEuL), CRC(0xBFuL),
	CRC(0xC0uL), CRC(0xC1uL), CRC(0xC2uL), CRC(0xC3uL), CRC(0xC4uL), CRC(0xC5uL), CRC(0xC6uL), CRC(0xC7uL), CRC(0xC8uL), CRC(0xC9uL), CRC(0xCAuL), CRC(0xCBuL), CRC(0xCCuL), CRC(0xCDuL), CRC(0xCEuL), CRC(0xCFuL),
	CRC(0xD0uL), CRC(0xD1uL), CRC(0xD2uL), CRC(0xD3uL), CRC(0xD4uL), CRC(0xD5uL), CRC(0xD6uL), CRC(0xD7uL), CRC(0xD8uL), CRC(0xD9uL), CRC(0xDAuL), CRC(0xDBuL), CRC(0xDCuL), CRC(0xDDuL), CRC(0xDEuL), CRC(0xDFuL),
	CRC(0xE0uL), CRC(0xE1uL), CRC(0xE2uL), CRC(0xE3uL), CRC(0xE4uL), CRC(0xE5uL), CRC(0xE6uL), CRC(0xE7uL), CRC(0xE8uL), CRC(0xE9uL), CRC(0xEAuL), CRC(0xEBuL), CRC(0xECuL), CRC(0xEDuL), CRC(0xEEuL), CRC(0xEFuL),
	CRC(0xF0uL), CRC(0xF1uL), CRC(0xF2uL), CRC(0xF3uL), CRC(0xF4uL), CRC(0xF5uL), CRC(0xF6uL), CRC(0xF7uL), CRC(0xF8uL), CRC(0xF9uL), CRC(0xFAuL), CRC(0xFBuL), CRC(0xFCuL), CRC(0xFDuL), CRC(0xFEuL), CRC(0xFFuL),
};

unsigned long int crc32(unsigned long int crc, const void *message, size_t length)
{
	if (message) {
		const unsigned char *p = message;

		while (length--) {
			crc = (crc >> 010) ^ table[(crc ^ *p++) & 0xFFuL];
		}
	}

	return crc;
}
